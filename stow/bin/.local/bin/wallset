#!/usr/bin/env bash
set -Eeuo pipefail

# ----------------------------
# Config (ajusta a tu gusto)
# ----------------------------
WALL_DIR_DEFAULT="${WALL_DIR_DEFAULT:-$HOME/Pictures/Wallpapers}"
TRANSITION_DEFAULT="${TRANSITION_DEFAULT:-grow}"   # any | fade | grow | wipe | outer | wave | simple
DURATION_DEFAULT="${DURATION_DEFAULT:-0.8}"        # segundos
FPS_DEFAULT="${FPS_DEFAULT:-60}"
BEZIER_DEFAULT="${BEZIER_DEFAULT:-0.1,0.9,0.2,1.0}"

# Para transitions que usan "pos". Si pones "cursor", se traduce a "x,y" usando hyprctl cursorpos.
# Si no hay hyprctl/Hyprland, cae a "center".
POS_DEFAULT="${POS_DEFAULT:-cursor}"  # cursor | center | top-left | ... | "x,y"

# ----------------------------
# Logging
# ----------------------------
log()  { printf "%s\n" "$*"; }
info() { log "INFO: $*"; }
ok()   { log "OK:   $*"; }
warn() { log "WARN: $*"; }
die()  { log "ERR:  $*"; exit 1; }

have() { command -v "$1" >/dev/null 2>&1; }

# ----------------------------
# Helpers
# ----------------------------
ensure_swww() {
  have swww || die "Falta 'swww'. Instálalo (pacman/AUR según tu lista)."

  # Si ya responde, ok
  if swww query >/dev/null 2>&1; then
    return 0
  fi

  # Intentar levantar daemon (sin systemd)
  info "swww no está activo. Iniciando daemon..."
  (swww-daemon >/dev/null 2>&1 & disown) || true

  # esperar breve
  for _ in {1..20}; do
    swww query >/dev/null 2>&1 && return 0
    sleep 0.1
  done

  die "No pude iniciar swww-daemon."
}

pick_wallpaper() {
  local arg="${1:-}"
  local dir="${2:-$WALL_DIR_DEFAULT}"

  if [[ -n "$arg" ]]; then
    [[ -f "$arg" ]] || die "No existe el archivo: $arg"
    echo "$arg"
    return 0
  fi

  [[ -d "$dir" ]] || die "No existe el directorio de wallpapers: $dir"

  # Soporta espacios y extensiones comunes
  mapfile -t files < <(find "$dir" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) | sort)
  ((${#files[@]} > 0)) || die "No encontré imágenes en: $dir"

  # random seguro
  local idx=$((RANDOM % ${#files[@]}))
  echo "${files[$idx]}"
}

hypr_cursorpos_xy() {
  # hyprctl cursorpos suele devolver "x, y" (con coma y/o espacios). Normalizamos a "x,y".
  have hyprctl || return 1
  hyprctl cursorpos >/dev/null 2>&1 || return 1
  hyprctl cursorpos | tr -d ' ' | sed 's/,$//'
}

apply_swww() {
  local img="$1"
  local transition="${2:-$TRANSITION_DEFAULT}"
  local duration="${3:-$DURATION_DEFAULT}"
  local fps="${4:-$FPS_DEFAULT}"
  local bezier="${5:-$BEZIER_DEFAULT}"
  local pos="${6:-$POS_DEFAULT}"

  ensure_swww

  local invert_y=""
  if [[ "$pos" == "cursor" ]]; then
    if xy="$(hypr_cursorpos_xy)"; then
      pos="$xy"
      invert_y="--invert-y"
      info "Usando transition-pos desde cursor: $pos (con $invert_y)"
    else
      pos="center"
      info "No pude obtener cursor (hyprctl). Usando transition-pos: $pos"
    fi
  fi

  info "Aplicando wallpaper con swww..."
  info "  img: $img"
  info "  transition: $transition  duration: $duration  fps: $fps"
  info "  pos: $pos"

  swww img "$img" \
    --transition-type "$transition" \
    --transition-duration "$duration" \
    --transition-fps "$fps" \
    --transition-bezier "$bezier" \
    --transition-pos "$pos" \
    $invert_y

  ok "Wallpaper aplicado."
}

apply_wal() {
  local img="$1"

  if ! have wal; then
    warn "pywal (wal) no está instalado; saltando colores."
    return 0
  fi

  info "Generando paleta con pywal..."
  wal -n -q -i "$img"
  ok "pywal aplicado (~/.cache/wal/* actualizado)."
}

reload_targets() {
  if have hyprctl && hyprctl monitors >/dev/null 2>&1; then
    info "Hyprland está activo. (No hago hyprctl reload automáticamente para evitar glitches de monitores.)"
    info "Si tus colores de wal se aplican vía 'source', reinicia sesión o ejecuta hyprctl reload manualmente."
  fi

  if have pkill; then
    pkill -USR1 kitty >/dev/null 2>&1 || true
  fi

  if have waybar && have pkill; then
    pkill -SIGUSR2 waybar >/dev/null 2>&1 || true
  fi

  ok "Recargas enviadas (kitty/waybar si aplicaba)."
}

usage() {
  cat <<EOF
Uso:
  wallset [IMAGEN] [--dir DIR] [--transition TYPE] [--duration SEC]

Ejemplos:
  wallset
  wallset --dir ~/Pictures/Walls
  wallset ~/Pictures/Wallpapers/wall.png
  wallset --transition fade --duration 1.2

Notas:
  - Requiere swww + swww-daemon.
  - Si POS_DEFAULT=cursor, se traduce a coordenadas usando 'hyprctl cursorpos'.
  - Si tienes pywal (wal), generará paleta en ~/.cache/wal/
EOF
}

main() {
  local img_arg=""
  local dir="$WALL_DIR_DEFAULT"
  local transition="$TRANSITION_DEFAULT"
  local duration="$DURATION_DEFAULT"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help) usage; exit 0 ;;
      --dir) dir="${2:-}"; shift 2 ;;
      --transition) transition="${2:-}"; shift 2 ;;
      --duration) duration="${2:-}"; shift 2 ;;
      --) shift; break ;;
      -*)
        die "Opción desconocida: $1"
        ;;
      *)
        if [[ -z "$img_arg" ]]; then
          img_arg="$1"
          shift
        else
          die "Argumento extra inesperado: $1"
        fi
        ;;
    esac
  done

  local img
  img="$(pick_wallpaper "$img_arg" "$dir")"

  apply_swww "$img" "$transition" "$duration"
  apply_wal "$img"
  reload_targets

  ok "Listo."
}

main "$@"
